generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
model ListenerSource {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  platform          String
  url               String
  enabled           Boolean  @default(true)
  pollIntervalSec   Int      @default(300) @map("poll_interval_sec")
  lastPolledAt      DateTime? @map("last_polled_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, url])
  @@index([tenantId, platform])
  @@map("listener_sources")
}
model Tenant {
  id                                       String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug                                     String              @unique
  name                                     String
  createdAt                                DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                                DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  app_users_app_users_tenant_idTotenant_id app_users[]         @relation("app_users_tenant_idTotenant_id")
  assets                                   Asset[]
  audits                                   AuditLog[]          @relation("TenantAudits")
  decision_memos                           DecisionMemo[]
  distribution_events                      DistributionEvent[]
  growth_loop_runs                         GrowthLoopRun[]
  integrations                             Integration[]
  jobs                                     Job[]
  kbDocuments                              KbDocument[]
  kbTags                                   KbTag[]
  ledger                                   LedgerEntry[]
  metrics_snapshots                        MetricsSnapshot[]
  members                                  TenantMember[]
  TicketComment                            TicketComment[]
  Ticket                                   Ticket[]
  crmContacts                              CrmContact[]
  crmCompanies                             CrmCompany[]
  crmSegments                              CrmSegment[]
  contactActivities                        ContactActivity[]
  cannedResponses                          CannedResponse[]
  budgets                                  Budget[]
  decisionTemplates                        DecisionTemplate[]
  agentMemory                              AgentMemory[]
  toolProposals                            ToolProposal[]
  dataSubjectRequests                      DataSubjectRequest[]
  consentRecords                           ConsentRecord[]
  dataBreaches                             DataBreach[]
  incidentReports                          IncidentReport[]
  vendorAssessments                        VendorAssessment[]
  meetingNotes                             MeetingNote[]
  browserSessions                          BrowserSession[]

  @@map("tenants")
}

model CrmContact {
  id         String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String              @map("tenant_id") @db.Uuid
  firstName  String?             @map("first_name")
  lastName   String?             @map("last_name")
  email      String?
  phone      String?
  company    String?
  source     String?             @default("manual")
  tags       String[]            @default([])
  notes      String?
  createdAt  DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant     Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  activities ContactActivity[]

  @@index([tenantId])
  @@index([tenantId, email])
  @@map("crm_contacts")
}

model ContactActivity {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String     @map("tenant_id") @db.Uuid
  contactId  String     @map("contact_id") @db.Uuid
  type       String     // email, call, note, meeting, mention, sms
  subject    String?
  body       String?
  meta       Json       @default("{}")
  occurredAt DateTime   @default(now()) @map("occurred_at") @db.Timestamptz(6)
  createdAt  DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  contact    CrmContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([contactId, occurredAt(sort: Desc)])
  @@index([tenantId, occurredAt(sort: Desc)])
  @@map("contact_activities")
}

model CrmSegment {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String
  description String?
  filters     Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("crm_segments")
}

model CrmCompany {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  name      String
  domain    String?
  industry  String?
  notes     String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("crm_companies")
}

model Integration {
  id               String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String               @map("tenant_id") @db.Uuid
  provider         String
  connected        Boolean              @default(false)
  access_token     String?
  refresh_token    String?
  token_expires_at DateTime?            @db.Timestamptz(6)
  scopes           Json                 @default("[]")
  config           Json                 @default("{}")
  status           Json                 @default("{}")
  last_sync_at     DateTime?            @db.Timestamptz(6)
  created_at       DateTime             @default(now()) @db.Timestamptz(6)
  updated_at       DateTime             @default(now()) @db.Timestamptz(6)
  tenant           Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenantId, provider])
  @@index([provider])
  @@index([tenantId], map: "integrations_tenant_idx")
  @@map("integrations")
}

model TokenVault {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  provider      String
  accessToken   String   @map("access_token")
  refreshToken  String?  @map("refresh_token")
  expiresAt     String?  @map("expires_at")
  scope         String?
  meta          Json?
  updatedAt     DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@unique([orgId, userId, provider])
  @@index([orgId, provider])
  @@map("token_vault")
}

model AuditLog {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String?    @map("tenant_id") @db.Uuid
  actorUserId     String?    @map("actor_user_id") @db.Uuid
  actorExternalId String?    @map("actor_external_id")
  actorType       String?    @default("user") @map("actor_type")
  level           AuditLevel @default(info) @map("level")
  action          String
  entityType      String?    @map("entity_type")
  entityId        String?    @map("entity_id") @db.Uuid
  message         String?
  meta            Json       @default("{}") @map("meta")
  createdAt       DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  timestamp       DateTime?  @map("timestamp") @db.Timestamptz(6)
  app_users       app_users? @relation(fields: [actorUserId], references: [id], onUpdate: NoAction)
  tenant          Tenant?    @relation("TenantAudits", fields: [tenantId], references: [id], onUpdate: NoAction)

  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@index([entityType, entityId], map: "audit_log_entity_idx")
  @@index([tenantId, createdAt(sort: Desc)], map: "audit_log_tenant_time_idx")
  @@map("audit_log")
}

model Job {
  id                   String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String     @map("tenant_id") @db.Uuid
  requested_by_user_id String?    @db.Uuid
  status               job_status @default(queued)
  jobType              String     @map("job_type")
  priority             Int        @default(0)
  input                Json       @default("{}")
  output               Json       @default("{}")
  error                Json       @default("{}")
  costCents            Int        @default(0) @map("cost_cents")
  retryCount           Int        @default(0) @map("retry_count")
  maxRetries           Int        @default(3) @map("max_retries")
  nextRetryAt          DateTime?  @map("next_retry_at") @db.Timestamptz(6)
  startedAt            DateTime?  @map("started_at") @db.Timestamptz(6)
  finishedAt           DateTime?  @map("finished_at") @db.Timestamptz(6)
  createdAt            DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant               Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  decisionMemos DecisionMemo[]

  @@index([createdAt(sort: Desc)], map: "jobs_created_idx")
  @@index([tenantId, status], map: "jobs_tenant_status_idx")
  @@index([status, nextRetryAt], map: "jobs_retry_idx")
  @@map("jobs")
}

model TenantMember {
  tenantId  String    @map("tenant_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  role      String    @default("member")
  seatType  SeatType  @default(free_beta) @map("seat_type")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      User?     @relation("UserMemberships", fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([tenantId, userId])
  @@map("tenant_members")
}

model LedgerEntry {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String          @map("tenant_id") @db.Uuid
  entryType      LedgerEntryType @map("entry_type")
  category       LedgerCategory
  amountCents    BigInt          @map("amount_cents")
  currency       String          @default("USD")
  description    String?
  externalRef    String?         @map("external_ref")
  meta           Json            @default("{}")
  occurredAt     DateTime        @default(now()) @map("occurred_at") @db.Timestamptz(6)
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  reference_type String?
  reference_id   String?
  run_id         String?
  metadata       Json?
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([category], map: "ledger_category_idx")
  @@index([tenantId])
  @@index([tenantId, occurredAt(sort: Desc)], map: "ledger_entries_tenant_occurred_at_idx")
  @@map("ledger_entries")
}

model Asset {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  type      String
  name      String
  url       String
  platform  String?
  metrics   Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId])
  @@map("assets")
}

model KbDocument {
  id               String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String            @map("tenant_id") @db.Uuid
  title            String
  slug             String
  body             String
  featuredImageUrl String?           @map("featured_image_url")
  status           KbDocumentStatus  @default(draft)
  createdBy        String            @map("created_by") @db.Uuid
  updatedBy        String?           @map("updated_by") @db.Uuid
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tags             KbTagOnDocument[]

  @@unique([tenantId, slug])
  @@index([tenantId, status, updatedAt])
  @@map("kb_documents")
}

model KbTag {
  id        String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String            @map("tenant_id") @db.Uuid
  name      String
  createdAt DateTime          @default(now()) @map("created_at")
  docs      KbTagOnDocument[]
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@map("kb_tags")
}

model KbTagOnDocument {
  documentId String     @map("document_id") @db.Uuid
  tagId      String     @map("tag_id") @db.Uuid
  assignedAt DateTime   @default(now()) @map("assigned_at")
  document   KbDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tag        KbTag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([documentId, tagId])
  @@index([tagId])
  @@map("kb_tag_on_document")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model agent_registry {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id  String    @db.Uuid
  name       String
  role       String?
  status     String?   @default("DRAFT")
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([tenant_id])
}

model app_users {
  id                                       String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                String          @db.Uuid
  external_user_id                         String?
  email                                    String?
  display_name                             String?
  role                                     String?         @default("user")
  created_at                               DateTime        @default(now()) @db.Timestamptz(6)
  updated_at                               DateTime        @default(now()) @db.Timestamptz(6)
  tenant_id_app_users_tenant_idTotenant_id Tenant          @relation("app_users_tenant_idTotenant_id", fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  audit_log                                AuditLog[]
  TicketComment                            TicketComment[]
  Ticket                                   Ticket[]

  @@unique([tenant_id, external_user_id])
  @@index([tenant_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model approvals {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  intent_type  String
  payload_hash String
  approved_by  String    @db.Uuid
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  expires_at   DateTime? @db.Timestamptz(6)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// Engine intent queue (Atlas engine)
model Intent {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String    @map("tenant_id") @db.Uuid
  agentId    String?   @map("agent_id") @db.Uuid
  intentType String?   @map("intent_type")
  payload    Json?
  sglResult  String?   @map("sgl_result")
  status     String?   @default("DRAFT")
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  decisionMemos DecisionMemo[]

  @@index([status, createdAt])
  @@map("intents")
}

/// Decision memos (spend/approval governance)
model DecisionMemo {
  id               String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String          @map("tenant_id") @db.Uuid
  agent            String
  title            String
  rationale        String
  estimatedCostUsd Float           @default(0) @map("estimated_cost_usd")
  billingType      String          @default("none") @map("billing_type")
  riskTier         Int             @default(0) @map("risk_tier")
  confidence       Float           @default(0.5)
  expectedBenefit  String?         @map("expected_benefit")
  requiresApproval Boolean         @default(false) @map("requires_approval")
  status           String          @default("PROPOSED")
  payload          Json            @default("{}")
  jobId            String?         @map("job_id") @db.Uuid
  intentId         String?         @map("intent_id") @db.Uuid
  createdAt        DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime        @default(now()) @map("updated_at") @db.Timestamptz(6)
  tenants          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sourceJob        Job?            @relation(fields: [jobId], references: [id], onUpdate: NoAction)
  sourceIntent     Intent?         @relation(fields: [intentId], references: [id], onUpdate: NoAction)
  growth_loop_runs GrowthLoopRun[]

  @@index([tenantId, createdAt(sort: Desc)], map: "decision_memos_tenant_time_idx")
  @@index([jobId], map: "decision_memos_job_idx")
  @@index([intentId], map: "decision_memos_intent_idx")
  @@map("decision_memos")
}

model Ticket {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String          @map("tenant_id") @db.Uuid
  reporterUserId String?         @map("reporter_user_id") @db.Uuid
  runId          String?         @map("run_id")
  agent          String?
  status         TicketStatus    @default(OPEN)
  severity       TicketSeverity  @default(MEDIUM)
  category       TicketCategory  @default(BUG)
  title          String
  description    String?
  meta           Json            @default("{}") @map("meta")
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  comments       TicketComment[]
  reporter       app_users?      @relation(fields: [reporterUserId], references: [id], onUpdate: NoAction)
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId, createdAt(sort: Desc)], map: "tickets_tenant_time_idx")
  @@index([tenantId, status, createdAt(sort: Desc)], map: "tickets_tenant_status_idx")
  @@index([tenantId, severity, createdAt(sort: Desc)], map: "tickets_tenant_severity_idx")
  @@map("tickets")
}

model TicketComment {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String     @map("tenant_id") @db.Uuid
  ticketId     String     @map("ticket_id") @db.Uuid
  authorUserId String?    @map("author_user_id") @db.Uuid
  body         String
  meta         Json       @default("{}") @map("meta")
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  author       app_users? @relation(fields: [authorUserId], references: [id], onUpdate: NoAction)
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  ticket       Ticket     @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([ticketId, createdAt], map: "ticket_comments_ticket_time_idx")
  @@map("ticket_comments")
}

/// Distribution events (publishes/posts)
model DistributionEvent {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  agent       String   @default("unknown")
  channel     String   @default("other")
  eventType   String   @map("event_type")
  url         String?
  meta        Json     @default("{}")
  impressions Int?
  clicks      Int?
  conversions Int?
  occurredAt  DateTime @default(now()) @map("occurred_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  tenants     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId, occurredAt(sort: Desc)], map: "distribution_events_tenant_time_idx")
  @@map("distribution_events")
}

/// Daily metrics snapshots (stored JSON)
model MetricsSnapshot {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  date      DateTime @db.Date
  data      Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)
  tenants   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenantId, date], map: "metrics_snapshot_tenant_date_key")
  @@index([tenantId, date(sort: Desc)], map: "metrics_snapshot_tenant_date_idx")
  @@map("metrics_snapshots")
}

/// Growth loop runs (one per day)
model GrowthLoopRun {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String        @map("tenant_id") @db.Uuid
  runDate        DateTime      @map("run_date") @db.Date
  status         String        @default("STARTED")
  decisionMemoId String?       @map("decision_memo_id") @db.Uuid
  summary        Json          @default("{}")
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime      @default(now()) @map("updated_at") @db.Timestamptz(6)
  decision_memos DecisionMemo? @relation(fields: [decisionMemoId], references: [id], onUpdate: NoAction)
  tenants        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenantId, runDate], map: "growth_loop_runs_tenant_run_date_key")
  @@map("growth_loop_runs")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model publish_events {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenant_id       String?   @db.Uuid
  action          String    @default("publish")
  platform        String
  destination     String?
  asset_url       String
  asset_type      String?
  asset_hash      String?
  campaign        String?
  utm_campaign    String?
  status          String    @default("pending")
  dry_run         Boolean   @default(false)
  response_id     String?
  response_status Int?
  response_body   Json?
  error_message   String?
  triggered_by    String?   @default("atlas")
  workflow_name   String?
  run_id          String?
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  completed_at    DateTime? @db.Timestamptz(6)

  @@index([tenant_id], map: "idx_publish_events_tenant")
  @@index([campaign], map: "idx_publish_events_campaign")
  @@index([created_at(sort: Desc)], map: "idx_publish_events_created_at")
  @@index([platform], map: "idx_publish_events_platform")
  @@index([status], map: "idx_publish_events_status")
}

model agent_inboxes {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agent_key       String
  inbox_email     String
  inbox_type      String   @default("shared")
  audit_required  Boolean  @default(true)
  operator_access Json     @default("[]")
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)
  agents          agents   @relation(fields: [agent_key], references: [agent_key], onDelete: Cascade, onUpdate: NoAction)

  @@unique([agent_key, inbox_email])
}

model agents {
  id               String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agent_key        String          @unique
  display_name     String
  staff_role       String
  description      String?
  truth_required   Boolean         @default(true)
  advisory_only    Boolean         @default(false)
  can_block        Boolean         @default(false)
  tools_allowed    Json            @default("[]")
  tools_restricted Json            @default("[]")
  metadata         Json            @default("{}")
  created_at       DateTime        @default(now()) @db.Timestamptz(6)
  updated_at       DateTime        @default(now()) @db.Timestamptz(6)
  agent_inboxes    agent_inboxes[]
  workflows        workflows[]

  @@index([agent_key])
}

model atlas_agents {
  agent_key  String   @id
  agent_doc  Json
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model atlas_ip_approvals {
  approval_id       String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String?            @db.Uuid
  request_id        String?            @db.Uuid
  token             String             @unique
  status            String?            @default("pending")
  decided_by        String?
  decided_at        DateTime?          @db.Timestamptz(6)
  expires_at        DateTime?          @db.Timestamptz(6)
  created_at        DateTime?          @default(now()) @db.Timestamptz(6)
  atlas_ip_requests atlas_ip_requests? @relation(fields: [request_id], references: [request_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id], map: "idx_ip_approvals_tenant")
  @@index([status, expires_at], map: "idx_ip_approvals_status_expires")
}

model atlas_ip_artifacts {
  artifact_id       String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String?            @db.Uuid
  request_id        String?            @db.Uuid
  source_url        String?
  canonical_url     String?
  filename          String?
  uri               String?
  sha256            String?
  retrieved_at      DateTime?          @db.Timestamptz(6)
  meta              Json?              @default("{}")
  created_at        DateTime?          @default(now()) @db.Timestamptz(6)
  atlas_ip_requests atlas_ip_requests? @relation(fields: [request_id], references: [request_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id], map: "idx_ip_artifacts_tenant")
  @@index([request_id], map: "idx_ip_artifacts_request")
}

model atlas_ip_messages {
  message_id        String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String?            @db.Uuid
  request_id        String?            @db.Uuid
  message_type      String
  payload           Json?              @default("{}")
  actor             String?
  received_at       DateTime?          @default(now()) @db.Timestamptz(6)
  atlas_ip_requests atlas_ip_requests? @relation(fields: [request_id], references: [request_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id], map: "idx_ip_messages_tenant")
  @@index([request_id], map: "idx_ip_messages_request")
}

model atlas_ip_reports {
  report_id         String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String?            @db.Uuid
  request_id        String?            @db.Uuid
  summary           String?
  risk_level        String?
  decision_tree     Json?              @default("[]")
  checklist         Json?              @default("[]")
  missing_facts     Json?              @default("[]")
  citations         Json?              @default("[]")
  artifacts         Json?              @default("[]")
  created_by        String?            @default("benny.cto@deadapp.info")
  created_at        DateTime?          @default(now()) @db.Timestamptz(6)
  atlas_ip_requests atlas_ip_requests? @relation(fields: [request_id], references: [request_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id], map: "idx_ip_reports_tenant")
  @@index([request_id], map: "idx_ip_reports_request")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model atlas_ip_requests {
  request_id             String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id              String?              @db.Uuid
  raw_payload            Json
  company                String?
  asset_type             String
  jurisdiction           String
  question               String
  facts                  String?
  links                  Json?                @default("[]")
  constraints            Json?                @default("[]")
  requested_by           String?
  receipt_id             String?
  atlas_thread_id        String?
  status                 String?              @default("open")
  compliance_stop        Boolean?             @default(false)
  compliance_stop_reason String?
  received_by            String?              @default("atlas")
  received_at            DateTime?            @default(now()) @db.Timestamptz(6)
  created_at             DateTime?            @default(now()) @db.Timestamptz(6)
  updated_at             DateTime?            @default(now()) @db.Timestamptz(6)
  atlas_ip_approvals     atlas_ip_approvals[]
  atlas_ip_artifacts     atlas_ip_artifacts[]
  atlas_ip_messages      atlas_ip_messages[]
  atlas_ip_reports       atlas_ip_reports[]

  @@index([tenant_id], map: "idx_ip_requests_tenant")
  @@index([status], map: "idx_ip_requests_status")
}

model atlas_suggestion_messages {
  id                String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  suggestion_id     String?            @db.Uuid
  message_id        String?
  from_address      String?
  subject           String?
  body              String?
  received_at       DateTime?          @default(now()) @db.Timestamptz(6)
  atlas_suggestions atlas_suggestions? @relation(fields: [suggestion_id], references: [suggestion_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([suggestion_id], map: "idx_suggestion_messages_suggestion_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model atlas_suggestions {
  suggestion_id             String                      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenant_id                 String?                     @db.Uuid
  ticket_id                 String?
  ticket_subject            String?
  ticket_body               String?
  kb_results                Json?
  one_line_summary          String?
  implementation_plan       Json?
  email_subject             String?
  email_body_approve        String?
  email_body_deny           String?
  approval_token            String                      @unique(map: "idx_suggestions_approval_token")
  status                    String?                     @default("pending")
  created_at                DateTime?                   @default(now()) @db.Timestamptz(6)
  updated_at                DateTime?                   @default(now()) @db.Timestamptz(6)
  expires_at                DateTime?                   @db.Timestamptz(6)
  decided_at                DateTime?                   @db.Timestamptz(6)
  decided_by                String?
  decision_message_id       String?
  atlas_suggestion_messages atlas_suggestion_messages[]

  @@index([tenant_id], map: "idx_suggestions_tenant")
  @@index([status, expires_at], map: "idx_suggestions_status_expires")
}

model atlas_workflows {
  workflow_id  String   @id
  agent_key    String
  workflow_doc Json
  status       String   @default("ready")
  version      String?
  name         String?
  trigger_type String?
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @db.Timestamptz(6)
}

model workflow_steps {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workflow_key String
  step_order   Int
  step_id      String
  step_type    String
  description  String?
  config       Json      @default("{}")
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime  @default(now()) @db.Timestamptz(6)
  workflows    workflows @relation(fields: [workflow_key], references: [workflow_key], onDelete: Cascade, onUpdate: NoAction)

  @@unique([workflow_key, step_id])
  @@unique([workflow_key, step_order])
}

model workflows {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workflow_key   String           @unique
  agent_key      String
  name           String
  version        String           @default("1.0.0")
  status         String           @default("ready")
  trigger        Json             @default("{}")
  policy         Json             @default("{}")
  outputs        Json             @default("{}")
  metadata       Json             @default("{}")
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  updated_at     DateTime         @default(now()) @db.Timestamptz(6)
  workflow_id    String           @unique(map: "workflows_workflow_id_uidx")
  enabled        Boolean?         @default(true)
  workflow_steps workflow_steps[]
  agents         agents           @relation(fields: [agent_key], references: [agent_key], onDelete: Cascade, onUpdate: NoAction)
}

model agent_inbox_events {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id           String   @db.Uuid
  agent_key           String
  inbox_email         String
  provider            String   @default("manual")
  provider_message_id String?
  from_email          String?
  from_name           String?
  subject             String?
  body_text           String?
  body_html           String?
  received_at         DateTime @default(now()) @db.Timestamptz(6)
  status              String   @default("new")
  metadata            Json     @default("{}")
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  updated_at          DateTime @default(now()) @db.Timestamptz(6)

  @@unique([provider, provider_message_id], map: "agent_inbox_events_dedupe_idx")
  @@index([agent_key, received_at(sort: Desc)], map: "agent_inbox_events_agent_time_idx")
  @@index([tenant_id, received_at(sort: Desc)], map: "agent_inbox_events_tenant_time_idx")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model audit_events__old {
  id         String    @id(map: "audit_events_pkey") @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id  String    @db.Uuid
  intent_id  String?   @db.Uuid
  event_type String?
  event_data Json?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
}

model KbDocumentVersion {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  documentId    String   @map("document_id") @db.Uuid
  title         String
  body          String
  editedBy      String   @map("edited_by") @db.Uuid
  editedAt      DateTime @default(now()) @map("edited_at") @db.Timestamptz(6)
  versionNum    Int      @map("version_num")
  changeSummary String?  @map("change_summary")

  @@index([documentId, versionNum(sort: Desc)])
  @@index([tenantId, editedAt(sort: Desc)])
  @@map("kb_document_versions")
}

model DecisionTemplate {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String   @map("tenant_id") @db.Uuid
  name             String
  description      String?
  defaultTitle     String?  @map("default_title")
  defaultRationale String?  @map("default_rationale")
  billingType      String   @default("none") @map("billing_type")
  riskTier         Int      @default(0) @map("risk_tier")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("decision_templates")
}

model CannedResponse {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  title     String
  body      String
  channel   String?
  tags      String[] @default([])
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, channel])
  @@map("canned_responses")
}

model Budget {
  id         String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String          @map("tenant_id") @db.Uuid
  name       String
  category   LedgerCategory?
  limitCents BigInt          @map("limit_cents")
  periodDays Int             @default(30) @map("period_days")
  alertAt    Float           @default(0.8) @map("alert_at")
  createdAt  DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("budgets")
}

model runtime_state {
  id             String    @id
  engine_enabled Boolean   @default(false)
  updated_at     DateTime? @default(now()) @db.Timestamptz(6)
}

model system_state {
  key        String    @id
  value      Json
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([updated_at(sort: Desc)], map: "system_state_updated_idx")
}

enum AuditLevel {
  info
  warn
  error
  security
}

enum LedgerEntryType {
  credit
  debit

  @@map("ledger_entry_type")
}

enum LedgerCategory {
  subscription
  token_spend
  api_spend
  refund
  chargeback
  payout
  misc

  @@map("ledger_category")
}

enum KbDocumentStatus {
  draft
  published
  archived

  @@map("kb_document_status")
}

enum audit_level {
  info
  warn
  error
  security
}

// integration_provider enum removed — provider column is now plain TEXT
// so any provider key can be stored: google, meta, x, reddit, tumblr, linkedin, pinterest, etc.

enum job_status {
  queued
  running
  succeeded
  failed
  canceled
}

enum TicketStatus {
  OPEN
  TRIAGED
  IN_PROGRESS
  CLOSED

  @@map("ticket_status")
}

enum TicketSeverity {
  LOW
  MEDIUM
  HIGH
  BLOCKER

  @@map("ticket_severity")
}

enum TicketCategory {
  BUG
  UX
  GUARDRAIL
  PERFORMANCE
  OTHER

  @@map("ticket_category")
}

/// Atlas-generated tool proposals awaiting human approve/deny.
model ToolProposal {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  agentId       String    @map("agent_id")        // which agent the tool is for
  toolName      String    @map("tool_name")
  toolPurpose   String    @map("tool_purpose")
  toolImpl      String?   @map("tool_impl")        // implementation notes
  approvalToken String    @unique @map("approval_token")
  status        String    @default("pending")       // pending | approved | denied
  runId         String?   @map("run_id")
  decidedAt     DateTime? @map("decided_at") @db.Timestamptz(6)
  decidedBy     String?   @map("decided_by")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([approvalToken])
  @@map("tool_proposals")
}

/// Per-agent Postgres conversation memory — used by the deep agent pipeline.
model AgentMemory {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  agentId   String   @map("agent_id")
  sessionId String   @map("session_id")
  role      String   // "user" | "assistant"
  content   String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, agentId, sessionId])
  @@index([tenantId, agentId, sessionId, createdAt(sort: Desc)])
  @@map("agent_memory")
}

// ─────────────────────────────────────────────────────────────────────────────
// Phase 1: Per-User Identity (global users, cross-tenant)
// ─────────────────────────────────────────────────────────────────────────────

/// Global user identity — exists independently of any tenant.
/// id matches the Supabase auth user id for compatibility.
model User {
  id            String         @id @db.Uuid
  email         String         @unique
  displayName   String?        @map("display_name")
  avatarUrl     String?        @map("avatar_url")
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  memberships   TenantMember[] @relation("UserMemberships")
  usageMeters   UsageMeter[]
  subscriptions Subscription[]

  @@map("users")
}

// ─────────────────────────────────────────────────────────────────────────────
// Phase 2: Usage Metering
// ─────────────────────────────────────────────────────────────────────────────

/// Per-user, per-tenant usage tracking — rolled up monthly.
model UsageMeter {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  period        String   // "2026-02" format — YYYY-MM
  tokensUsed    BigInt   @default(0) @map("tokens_used")
  apiCalls      Int      @default(0) @map("api_calls")
  jobsCreated   Int      @default(0) @map("jobs_created")
  storageBytes  BigInt   @default(0) @map("storage_bytes")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId, period])
  @@index([userId, tenantId])
  @@map("usage_meters")
}

// ─────────────────────────────────────────────────────────────────────────────
// Phase 3: Billing & Seats
// ─────────────────────────────────────────────────────────────────────────────

enum SeatType {
  free_beta
  starter
  pro
  enterprise

  @@map("seat_type")
}

/// Per-user subscription record tied to Stripe (or internal billing).
model Subscription {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String    @map("user_id") @db.Uuid
  tenantId           String    @map("tenant_id") @db.Uuid
  seatType           SeatType  @default(free_beta) @map("seat_type")
  stripeCustomerId   String?   @map("stripe_customer_id")
  stripeSubscriptionId String? @map("stripe_subscription_id")
  status             String    @default("active") // active | canceled | past_due | trialing
  currentPeriodStart DateTime? @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd   DateTime? @map("current_period_end") @db.Timestamptz(6)
  canceledAt         DateTime? @map("canceled_at") @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

model OAuthState {
  key       String   @id
  value     String
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)

  @@index([expiresAt])
  @@map("oauth_state")
}

// ─────────────────────────────────────────────────────────────────────────────
// Compliance: GDPR Data Subject Requests, Consent, Breach Tracking,
// Incident Response, Vendor Risk Management
// ─────────────────────────────────────────────────────────────────────────────

/// GDPR Data Subject Access Requests (DSAR) — right to access, erasure, portability, restriction, rectification
model DataSubjectRequest {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  requestType   String   @map("request_type") // access, erasure, portability, restriction, rectification, objection
  status        String   @default("pending") // pending, in_progress, completed, denied
  subjectEmail  String   @map("subject_email")
  subjectName   String?  @map("subject_name")
  requestedBy   String?  @map("requested_by") @db.Uuid // user who submitted (may be the subject or an admin)
  reason        String?
  response      String?  // admin response / denial reason
  dataExportUrl String?  @map("data_export_url") // signed URL for portability exports
  completedAt   DateTime? @map("completed_at") @db.Timestamptz(6)
  dueBy         DateTime  @map("due_by") @db.Timestamptz(6) // 30-day GDPR deadline
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([subjectEmail])
  @@index([dueBy])
  @@map("data_subject_requests")
}

/// GDPR Consent Records — tracks consent per user per processing purpose
model ConsentRecord {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  subjectEmail    String    @map("subject_email")
  purpose         String    // marketing, analytics, ai_processing, data_sharing, communications
  lawfulBasis     String    @map("lawful_basis") // consent, contract, legal_obligation, vital_interest, public_task, legitimate_interest
  granted         Boolean   @default(false)
  grantedAt       DateTime? @map("granted_at") @db.Timestamptz(6)
  withdrawnAt     DateTime? @map("withdrawn_at") @db.Timestamptz(6)
  ipAddress       String?   @map("ip_address")
  userAgent       String?   @map("user_agent")
  version         String    @default("1.0") // consent policy version
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, subjectEmail, purpose])
  @@index([tenantId])
  @@index([subjectEmail])
  @@map("consent_records")
}

/// Data Breach Register — GDPR 72-hour / HIPAA 60-day notification tracking
model DataBreach {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId            String    @map("tenant_id") @db.Uuid
  severity            String    // p0_critical, p1_high, p2_medium, p3_low
  status              String    @default("detected") // detected, contained, eradicated, recovered, closed
  title               String
  description         String
  dataTypesAffected   String[]  @map("data_types_affected") // pii, phi, payment, credentials, internal
  individualsAffected Int?      @map("individuals_affected")
  detectedAt          DateTime  @map("detected_at") @db.Timestamptz(6)
  containedAt         DateTime? @map("contained_at") @db.Timestamptz(6)
  notifyAuthorityBy   DateTime  @map("notify_authority_by") @db.Timestamptz(6) // 72 hours from detection (GDPR)
  authorityNotifiedAt DateTime? @map("authority_notified_at") @db.Timestamptz(6)
  notifyIndividualsBy DateTime? @map("notify_individuals_by") @db.Timestamptz(6) // 60 days (HIPAA)
  individualsNotifiedAt DateTime? @map("individuals_notified_at") @db.Timestamptz(6)
  rootCause           String?   @map("root_cause")
  remediationSteps    String?   @map("remediation_steps")
  postMortemUrl       String?   @map("post_mortem_url")
  reportedBy          String?   @map("reported_by") @db.Uuid
  incidentCommander   String?   @map("incident_commander")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([severity])
  @@index([notifyAuthorityBy])
  @@map("data_breaches")
}

/// Incident Reports — SOC 2 / ISO 27001 incident tracking
model IncidentReport {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  severity        String    // p0, p1, p2, p3
  status          String    @default("open") // open, investigating, mitigated, resolved, closed
  category        String    // security, availability, data_integrity, access_control, compliance, operational
  title           String
  description     String
  impactSummary   String?   @map("impact_summary")
  affectedSystems String[]  @map("affected_systems") // api, database, auth, agents, payments, storage
  reportedBy      String?   @map("reported_by") @db.Uuid
  assignedTo      String?   @map("assigned_to")
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz(6)
  rootCause       String?   @map("root_cause")
  resolution      String?
  lessonsLearned  String?   @map("lessons_learned")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([severity])
  @@index([category])
  @@map("incident_reports")
}

/// Vendor Risk Assessments — ISO 27001 A.15, SOC 2 vendor management
model VendorAssessment {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  vendorName        String    @map("vendor_name") // Supabase, Render, Vercel, Stripe, OpenAI, etc.
  category          String    // infrastructure, payment, ai_provider, communication, storage, analytics
  riskLevel         String    @map("risk_level") // critical, high, medium, low
  dataAccess        String[]  @map("data_access") // pii, phi, payment, credentials, usage_data, none
  complianceCerts   String[]  @map("compliance_certs") // soc2, hipaa, gdpr, pci_dss, iso27001
  hasDataProcessingAgreement Boolean @default(false) @map("has_dpa")
  hasBaa            Boolean   @default(false) @map("has_baa") // Business Associate Agreement (HIPAA)
  lastAssessedAt    DateTime? @map("last_assessed_at") @db.Timestamptz(6)
  nextAssessmentDue DateTime? @map("next_assessment_due") @db.Timestamptz(6)
  status            String    @default("active") // active, under_review, suspended, terminated
  notes             String?
  assessedBy        String?   @map("assessed_by") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, vendorName])
  @@index([tenantId])
  @@index([riskLevel])
  @@index([nextAssessmentDue])
  @@map("vendor_assessments")
}

/// Cloud seat gate codes — revocable access codes for collaborators.
/// Independent of tenant/auth (gate runs before login).
model CloudSeat {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code      String    @unique
  label     String                                  // e.g. "MIT CS Student"
  email     String?                                 // optional contact
  role      String    @default("collaborator")      // collaborator | viewer | admin
  active    Boolean   @default(true)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  revokedAt DateTime? @map("revoked_at") @db.Timestamptz(6)
  meta      Json      @default("{}")

  @@map("cloud_seats")
}

/// Atlas Orchestration Agent conversations and context
model AtlasConversation {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId           String   @map("session_id")
  userId              String   @map("user_id") @db.Uuid
  tenantId            String   @map("tenant_id") @db.Uuid
  conversationHistory Json     @map("conversation_history")
  userProfile          Json     @map("user_profile")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([sessionId])
  @@index([userId])
  @@index([tenantId])
  @@index([createdAt])
  @@map("atlas_conversations")
}

// ─────────────────────────────────────────────────────────────────────────────
// Meeting Notes — Teams/Zoom/Meet transcript capture + AI summarization
// ─────────────────────────────────────────────────────────────────────────────

/// Meeting notes — stores manually added or calendar-imported meetings,
/// with optional transcript + AI-generated summary & action items.
model MeetingNote {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  platform        String    // zoom, microsoft-teams, google-meet, webex, etc.
  title           String
  meetingUrl      String?   @map("meeting_url")
  scheduledAt     DateTime  @map("scheduled_at") @db.Timestamptz(6)
  durationMinutes Int?      @map("duration_minutes")
  attendees       Json      @default("[]") // [{ name, email }]
  transcript      String?   // raw transcript text
  summary         String?   // AI-generated summary
  actionItems     Json      @default("[]") @map("action_items") // [{ text, assignee?, done }]
  keyPoints       Json      @default("[]") @map("key_points")   // string[]
  status          String    @default("scheduled") // scheduled, in_progress, completed, processed, failed
  processedAt     DateTime? @map("processed_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, scheduledAt(sort: Desc)])
  @@index([tenantId, status])
  @@map("meeting_notes")
}

model BrowserSession {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String          @map("tenant_id") @db.Uuid
  intentId    String?         @map("intent_id") @db.Uuid
  jobId       String?         @map("job_id") @db.Uuid
  agentId     String          @map("agent_id")
  targetUrl   String          @map("target_url")
  purpose     String
  status      String          @default("pending") // pending | running | paused_approval | completed | failed
  riskTier    Int             @default(1) @map("risk_tier")
  result      Json            @default("{}")
  startedAt   DateTime?       @map("started_at") @db.Timestamptz(6)
  finishedAt  DateTime?       @map("finished_at") @db.Timestamptz(6)
  createdAt   DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  actions     BrowserAction[]
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([status])
  @@map("browser_sessions")
}

model BrowserAction {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId       String         @map("session_id") @db.Uuid
  actionType      String         @map("action_type") // navigate | click | type | extract | screenshot | submit | scroll
  target          String?        // CSS selector or URL
  value           String?        // text input or extracted data
  riskLevel       String         @default("low") @map("risk_level") // low | medium | high
  screenshotPath  String?        @map("screenshot_path")
  domSnapshot     String?        @map("dom_snapshot")
  approved        Boolean        @default(true)
  memoId          String?        @map("memo_id") @db.Uuid
  result          Json           @default("{}")
  executedAt      DateTime       @default(now()) @map("executed_at") @db.Timestamptz(6)
  session         BrowserSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, executedAt])
  @@map("browser_actions")
}
