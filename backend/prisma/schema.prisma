generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum IntegrationProvider {
  google
  microsoft
  icloud
  facebook
  instagram
  tiktok
  youtube
  twilio
  stripe
  openai
  deepseek
  supabase
}

enum AuditLevel {
  info
  warn
  error
  security
}

enum JobStatus {
  queued
  running
  succeeded
  failed
  canceled
}

enum LedgerEntryType {
  credit
  debit

  @@map("ledger_entry_type")
}

enum LedgerCategory {
  hosting
  saas
  domain
  email
  social
  infra
  ads
  other
  ai_spend
  subscription
  misc

  @@map("ledger_category")
}

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  slug      String   @unique
  name      String
  members TenantMember[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  integrations Integration[]
  audits       AuditLog[] @relation("TenantAudits")
  jobs         Job[]
  ledger       LedgerEntry[]
  assets       Asset[]

  @@map("tenants")
}

model Integration {
  id            String              @id @default(uuid())
  tenantId      String?             @db.Uuid @map("tenant_id")
  provider      IntegrationProvider
  connected     Boolean             @default(false)
  accessToken   String?
  refreshToken  String?
  tokenExpires  DateTime?
  scopes        Json?
  config        Json?
  status        Json?
  lastSyncAt    DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  tenant        Tenant?             @relation(fields: [tenantId], references: [id])
  @@unique([tenantId, provider])
  @@map("integrations")
}

model AuditLog {
  id              String     @id @default(uuid()) @db.Uuid

  tenantId        String?    @db.Uuid @map("tenant_id")
  tenant          Tenant?    @relation("TenantAudits", fields: [tenantId], references: [id])

  actorUserId     String?    @db.Uuid @map("actor_user_id")
  actorExternalId String?    @map("actor_external_id")
  actorType       String?    @map("actor_type")

  level           AuditLevel @map("level")
  action          String

  entityType      String?    @map("entity_type")
  entityId        String?    @db.Uuid @map("entity_id")

  message         String?
  meta            Json?      @map("meta")

  createdAt       DateTime   @default(now()) @map("created_at")
  timestamp       DateTime?  @map("timestamp")

  @@map("audit_log")
}

model Job {
  id            String      @id @default(uuid())
  tenantId      String      
  requestedBy   String?
  status        JobStatus   @default(queued)
  jobType       String
  priority      Int         @default(0)
  input         Json?
  output        Json?
  error         Json?
  startedAt     DateTime?
  finishedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  tenant        Tenant      @relation(fields: [tenantId], references: [id])
}
model TenantMember {
  tenantId  String   @db.Uuid @map("tenant_id")
  userId    String   @db.Uuid @map("user_id")
  role      String   @default("member")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, userId])
  @@map("tenant_members")
}
model LedgerEntry {
  id            String           @id @default(uuid()) @db.Uuid
  tenantId      String           @map("tenant_id") @db.Uuid
  entryType     LedgerEntryType  @map("entry_type")
  category      LedgerCategory
  amountCents   BigInt           @map("amount_cents")
  currency      String           @default("USD")
  description   String?
  externalRef   String?          @map("external_ref")
  meta          Json?
  occurredAt    DateTime         @map("occurred_at") @db.Timestamptz(6)
  createdAt     DateTime         @map("created_at") @db.Timestamptz(6)
  tenant        Tenant           @relation(fields: [tenantId], references: [id])
  @@map("ledger_entries")
}

model Asset {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  type      String
  name      String
  url       String
  platform  String?
  metrics   Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("assets")
}
