generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
enum KbStatus {
  DRAFT
  PUBLISHED
}

enum IntentStatus {
  DRAFT
  VALIDATING
  AWAITING_HUMAN
  BLOCKED_SGL
  EXECUTED
  FAILED

  @@map("intent_status")
}

enum IntegrationProvider {
  google
  microsoft
  icloud
  facebook
  instagram
  tiktok
  youtube
  twilio
  stripe
  openai
  deepseek
  supabase
}

enum AuditLevel {
  info
  warn
  error
  security
}

enum JobStatus {
  queued
  running
  succeeded
  failed
  canceled
}

enum LedgerEntryType {
  credit
  debit

  @@map("ledger_entry_type")
}

enum LedgerCategory {
  hosting
  saas
  domain
  email
  social
  infra
  ads
  other
  ai_spend
  subscription
  misc

  @@map("ledger_category")
}

model Tenant {
  id        String         @id @default(uuid()) @db.Uuid
  slug      String         @unique
  name      String
  members   TenantMember[]
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  
  integrations Integration[]
  audits       AuditLog[]    @relation("TenantAudits")
  jobs         Job[]
  ledger       LedgerEntry[]
  assets       Asset[]
  Intent       Intent[]
  // Knowledge Base
  kbDocuments  KbDocument[]
  kbTags       KbTag[]
  kb_chunks KbChunk[]

  // Daily system metrics snapshots (one row per day, per tenant)
  metricsSnapshots MetricsSnapshot[]

  @@map("tenant_id")
  
}

model Intent {
  id        String @id @default(uuid()) @db.Uuid
  tenantId  String @db.Uuid
  createdBy String @db.Uuid

  intentType String
  payload    Json

  status    IntentStatus @default(DRAFT)
  sglResult String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status, createdAt])
  @@map("intent")
}

model Integration {
  id           String              @id @default(uuid())
  tenantId     String?             @map("tenant_id") @db.Uuid
  provider     IntegrationProvider
  connected    Boolean             @default(false)
  accessToken  String?
  refreshToken String?
  tokenExpires DateTime?
  scopes       Json?
  config       Json?
  status       Json?
  lastSyncAt   DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  tenant       Tenant?             @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, provider])
  @@map("integrations")
}

model AuditLog {
  id String @id @default(uuid()) @db.Uuid

  tenantId String? @map("tenant_id") @db.Uuid
  tenant   Tenant? @relation("TenantAudits", fields: [tenantId], references: [id])

  actorUserId     String? @map("actor_user_id") @db.Uuid
  actorExternalId String? @map("actor_external_id")
  actorType       String? @map("actor_type")

  level  AuditLevel @map("level")
  action String

  entityType String? @map("entity_type")
  entityId   String? @map("entity_id") @db.Uuid

  message String?
  meta    Json?   @map("meta")

  createdAt DateTime  @default(now()) @map("created_at")
  timestamp DateTime? @map("timestamp")

  @@map("audit_log")
}

model Job {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  requestedBy String?   @map("requested_by") @db.Uuid
  status      JobStatus @default(queued)
  jobType     String    @map("job_type")
  priority    Int       @default(0)
  input       Json?
  output      Json?
  error       Json?
  startedAt   DateTime? @map("started_at")
  finishedAt  DateTime? @map("finished_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status, createdAt])
  @@map("jobs")
}

model TenantMember {
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String   @default("member")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, userId])
  @@map("tenant_members")
}

model LedgerEntry {
  id          String          @id @default(uuid()) @db.Uuid
  tenantId    String          @map("tenant_id") @db.Uuid
  entryType   LedgerEntryType @map("entry_type")
  category    LedgerCategory
  amountCents BigInt          @map("amount_cents")
  currency    String          @default("USD")
  description String?
  externalRef String?         @map("external_ref")
  meta        Json?
  occurredAt  DateTime        @map("occurred_at") @db.Timestamptz(6)
  createdAt   DateTime        @map("created_at") @db.Timestamptz(6)
  tenant      Tenant          @relation(fields: [tenantId], references: [id])

  @@map("ledger_entries")
}

model Asset {
  id       String @id @default(uuid()) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  type     String
  name     String
  url      String
  platform String?
  metrics  Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("assets")
}

model MetricsSnapshot {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  /// Snapshot date (UTC), stored as a DATE.
  date      DateTime @db.Date
  /// Arbitrary metrics payload (JSON).
  data      Json
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date])
  @@index([tenantId, date])
  @@map("metrics_snapshots")
}

enum KbDocumentStatus {
  draft
  published
  archived

  @@map("kb_document_status")
}

model KbDocument {
  id       String           @id @default(uuid()) @db.Uuid
  tenantId String           @map("tenant_id") @db.Uuid
  title    String
  slug     String
  body     String
  status   KbDocumentStatus @default(draft)

  createdBy String  @map("created_by") @db.Uuid
  updatedBy String? @map("updated_by") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tags   KbTagOnDocument[]
  chunks KbChunk[]

  @@unique([tenantId, slug])
  @@index([tenantId, status, updatedAt])
  @@map("kb_documents")
}

model KbChunk {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  idx        Int
  charStart  Int      @map("char_start")
  charEnd    Int      @map("char_end")
  content    String
  sourceUpdatedAt DateTime @map("source_updated_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document KbDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, idx])
  @@index([tenantId, documentId])
  @@index([tenantId, updatedAt])
  @@map("kb_chunks")
}


model KbTag {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  docs   KbTagOnDocument[]

  @@unique([tenantId, name])
  @@map("kb_tags")
}

model KbTagOnDocument {
  documentId String   @map("document_id") @db.Uuid
  tagId      String   @map("tag_id") @db.Uuid
  assignedAt DateTime @default(now()) @map("assigned_at")

  document KbDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tag      KbTag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([documentId, tagId])
  @@index([tagId])
  @@map("kb_tag_on_document")
}
