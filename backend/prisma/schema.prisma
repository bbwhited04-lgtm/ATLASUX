generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id                                       String          @id(map: "tenants_pkey") @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug                                     String          @unique(map: "tenants_slug_key")
  name                                     String
  createdAt                                DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                                DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  app_users_app_users_tenant_idTotenant_id app_users[]     @relation("app_users_tenant_idTotenant_id")
  assets                                   Asset[]
  audits                                   AuditLog[]      @relation("TenantAudits")
  integrations                             Integration[]
  jobs                                     Job[]
  kbDocuments                              KbDocument[]
  kbTags                                   KbTag[]
  ledger                                   LedgerEntry[]
  members                                  TenantMember[]
  KbChunk                                  KbChunk[]
  Ticket                                   Ticket[]
  TicketComment                            TicketComment[]

  @@map("tenants")
}

model Integration {
  id               String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String               @map("tenant_id") @db.Uuid
  provider         integration_provider
  connected        Boolean              @default(false)
  access_token     String?
  refresh_token    String?
  token_expires_at DateTime?            @db.Timestamptz(6)
  scopes           Json                 @default("[]")
  config           Json                 @default("{}")
  status           Json                 @default("{}")
  last_sync_at     DateTime?            @db.Timestamptz(6)
  created_at       DateTime             @default(now()) @db.Timestamptz(6)
  updated_at       DateTime             @default(now()) @db.Timestamptz(6)
  tenant           Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenantId, provider])
  @@index([provider])
  @@index([tenantId], map: "integrations_tenant_idx")
  @@map("integrations")
}

model AuditLog {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String?    @map("tenant_id") @db.Uuid
  actorUserId     String?    @map("actor_user_id") @db.Uuid
  actorExternalId String?    @map("actor_external_id")
  actorType       String?    @default("user") @map("actor_type")
  level           AuditLevel @default(info) @map("level")
  action          String
  entityType      String?    @map("entity_type")
  entityId        String?    @map("entity_id") @db.Uuid
  message         String?
  meta            Json       @default("{}") @map("meta")
  createdAt       DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  timestamp       DateTime?  @map("timestamp") @db.Timestamptz(6)
  app_users       app_users? @relation(fields: [actorUserId], references: [id], onUpdate: NoAction)
  tenant          Tenant?    @relation("TenantAudits", fields: [tenantId], references: [id], onUpdate: NoAction)

  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@index([entityType, entityId], map: "audit_log_entity_idx")
  @@index([tenantId, createdAt(sort: Desc)], map: "audit_log_tenant_time_idx")
  @@map("audit_log")
}

model Job {
  id                   String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String     @map("tenant_id") @db.Uuid
  requested_by_user_id String?    @db.Uuid
  status               job_status @default(queued)
  jobType              String     @map("job_type")
  priority             Int        @default(0)
  input                Json       @default("{}")
  output               Json       @default("{}")
  error                Json       @default("{}")
  startedAt            DateTime?  @map("started_at") @db.Timestamptz(6)
  finishedAt           DateTime?  @map("finished_at") @db.Timestamptz(6)
  createdAt            DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  app_users            app_users? @relation(fields: [requested_by_user_id], references: [id], onUpdate: NoAction)
  tenant               Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([createdAt(sort: Desc)], map: "jobs_created_idx")
  @@index([tenantId, status], map: "jobs_tenant_status_idx")
  @@map("jobs")
}

model TenantMember {
  tenantId  String    @map("tenant_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  role      String    @default("member")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([tenantId, userId])
  @@map("tenant_members")
}

model LedgerEntry {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String          @map("tenant_id") @db.Uuid
  entryType   LedgerEntryType @map("entry_type")
  category    LedgerCategory
  amountCents BigInt          @map("amount_cents")
  currency    String          @default("USD")
  description String?
  externalRef String?         @map("external_ref")
  meta        Json            @default("{}")
  occurredAt  DateTime        @default(now()) @map("occurred_at") @db.Timestamptz(6)
  createdAt   DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([category], map: "ledger_category_idx")
  @@index([category])
  @@index([tenantId])
  @@index([tenantId, occurredAt(sort: Desc)], map: "ledger_entries_tenant_occurred_at_idx")
  @@index([tenantId, occurredAt(sort: Desc)], map: "ledger_tenant_time_idx")
  @@map("ledger_entries")
}

model Asset {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  type      String
  name      String
  url       String
  platform  String?
  metrics   Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId])
  @@map("assets")
}

model KbDocument {
  id        String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String            @map("tenant_id") @db.Uuid
  title     String
  slug      String
  body      String
  status    KbDocumentStatus  @default(draft)
  createdBy String            @map("created_by") @db.Uuid
  updatedBy String?           @map("updated_by") @db.Uuid
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tags      KbTagOnDocument[]

  // ✅ THIS is what Prisma is complaining about (the “opposite relation field”)
  chunks KbChunk[] @relation("KbDocumentChunks")

  @@unique([tenantId, slug])
  @@index([tenantId, status, updatedAt])
  @@map("kb_documents")
}

model KbTag {
  id        String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String            @map("tenant_id") @db.Uuid
  name      String
  createdAt DateTime          @default(now()) @map("created_at")
  docs      KbTagOnDocument[]
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@map("kb_tags")
}

model KbTagOnDocument {
  documentId String     @map("document_id") @db.Uuid
  tagId      String     @map("tag_id") @db.Uuid
  assignedAt DateTime   @default(now()) @map("assigned_at")
  document   KbDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tag        KbTag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([documentId, tagId])
  @@index([tagId])
  @@map("kb_tag_on_document")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model agent_registry {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id  String    @db.Uuid
  name       String
  role       String?
  status     String?   @default("DRAFT")
  created_at DateTime? @default(now()) @db.Timestamptz(6)
}

model app_users {
  id                                       String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                String          @db.Uuid
  external_user_id                         String?
  email                                    String?
  display_name                             String?
  role                                     String?         @default("user")
  created_at                               DateTime        @default(now()) @db.Timestamptz(6)
  updated_at                               DateTime        @default(now()) @db.Timestamptz(6)
  tenant_id_app_users_tenant_idTotenant_id Tenant          @relation("app_users_tenant_idTotenant_id", fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  audit_log                                AuditLog[]
  jobs                                     Job[]
  Ticket                                   Ticket[]
  TicketComment                            TicketComment[]

  @@unique([tenant_id, external_user_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model approvals {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  intent_type  String
  payload_hash String
  approved_by  String    @db.Uuid
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  expires_at   DateTime? @db.Timestamptz(6)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model audit_events {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id  String    @db.Uuid
  intent_id  String?   @db.Uuid
  event_type String?
  event_data Json?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// Engine intent queue (Atlas engine)
model Intent {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String    @map("tenant_id") @db.Uuid
  agentId    String?   @map("agent_id") @db.Uuid
  intentType String?   @map("intent_type")
  payload    Json?     @default("{}")
  sglResult  String?   @map("sgl_result")
  status     String?   @default("DRAFT")
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId], map: "intents_tenant_idx")
  @@index([status], map: "intents_status_idx")
  @@map("intents")
}

/// Knowledge base chunks (derived from kb_documents)
model KbChunk {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  documentId      String   @map("document_id") @db.Uuid
  idx             Int
  charStart       Int      @map("char_start")
  charEnd         Int      @map("char_end")
  content         String
  sourceUpdatedAt DateTime @map("source_updated_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // ✅ ADD relation name so Prisma pairs it cleanly
  document KbDocument @relation("KbDocumentChunks", fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, idx], map: "kb_chunks_document_id_idx_key")
  @@index([tenantId, documentId], map: "kb_chunks_tenant_id_document_id_idx")
  @@index([tenantId, updatedAt], map: "kb_chunks_tenant_id_updated_at_idx")
  @@map("kb_chunks")
}

/// Decision memos (spend/approval governance)
model DecisionMemo {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String   @map("tenant_id") @db.Uuid
  agent            String
  title            String
  rationale        String
  estimatedCostUsd Float    @default(0) @map("estimated_cost_usd")
  billingType      String   @default("none") @map("billing_type")
  riskTier         Int      @default(0) @map("risk_tier")
  confidence       Float    @default(0.5)
  expectedBenefit  String?  @map("expected_benefit")
  requiresApproval Boolean  @default(false) @map("requires_approval")
  status           String   @default("PROPOSED")
  payload          Json?    @default("{}")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId, createdAt(sort: Desc)], map: "decision_memos_tenant_time_idx")
  @@map("decision_memos")
}

// Lightweight beta feedback tickets (NOT a full helpdesk)
model Ticket {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String         @map("tenant_id") @db.Uuid
  reporterUserId String?        @map("reporter_user_id") @db.Uuid
  runId          String?        @map("run_id")
  agent          String?
  status         TicketStatus   @default(OPEN)
  severity       TicketSeverity @default(MEDIUM)
  category       TicketCategory @default(BUG)
  title          String
  description    String?
  meta           Json           @default("{}") @map("meta")
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  reporter app_users?      @relation(fields: [reporterUserId], references: [id], onUpdate: NoAction)
  comments TicketComment[]

  @@index([tenantId, createdAt(sort: Desc)], map: "tickets_tenant_time_idx")
  @@index([tenantId, status, createdAt(sort: Desc)], map: "tickets_tenant_status_idx")
  @@index([tenantId, severity, createdAt(sort: Desc)], map: "tickets_tenant_severity_idx")
  @@map("tickets")
}

model TicketComment {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  ticketId     String   @map("ticket_id") @db.Uuid
  authorUserId String?  @map("author_user_id") @db.Uuid
  body         String
  meta         Json     @default("{}") @map("meta")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  ticket Ticket     @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  author app_users? @relation(fields: [authorUserId], references: [id], onUpdate: NoAction)

  @@index([ticketId, createdAt(sort: Asc)], map: "ticket_comments_ticket_time_idx")
  @@map("ticket_comments")
}

/// Distribution events (publishes/posts)
model DistributionEvent {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  agent       String   @default("unknown")
  channel     String   @default("other")
  eventType   String   @map("event_type")
  url         String?
  meta        Json?    @default("{}")
  impressions Int?
  clicks      Int?
  conversions Int?
  occurredAt  DateTime @default(now()) @map("occurred_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId, occurredAt(sort: Desc)], map: "distribution_events_tenant_time_idx")
  @@map("distribution_events")
}

/// Daily metrics snapshots (stored JSON)
model MetricsSnapshot {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  date      DateTime @db.Date
  data      Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, date], map: "metrics_snapshot_tenant_date_key")
  @@index([tenantId, date(sort: Desc)], map: "metrics_snapshot_tenant_date_idx")
  @@map("metrics_snapshots")
}

/// Growth loop runs (one per day)
model GrowthLoopRun {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  runDate        DateTime @map("run_date") @db.Date
  status         String   @default("STARTED")
  decisionMemoId String?  @map("decision_memo_id") @db.Uuid
  summary        Json?    @default("{}")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, runDate], map: "growth_loop_runs_tenant_run_date_key")
  @@map("growth_loop_runs")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model publish_events {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  action          String    @default("publish")
  platform        String
  destination     String?
  asset_url       String
  asset_type      String?
  asset_hash      String?
  campaign        String?
  utm_campaign    String?
  status          String    @default("pending")
  dry_run         Boolean   @default(false)
  response_id     String?
  response_status Int?
  response_body   Json?
  error_message   String?
  triggered_by    String?   @default("atlas")
  workflow_name   String?
  run_id          String?
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  completed_at    DateTime? @db.Timestamptz(6)

  @@index([campaign], map: "idx_publish_events_campaign")
  @@index([created_at(sort: Desc)], map: "idx_publish_events_created_at")
  @@index([platform], map: "idx_publish_events_platform")
  @@index([status], map: "idx_publish_events_status")
}

enum AuditLevel {
  info
  warn
  error
  security
}

enum LedgerEntryType {
  credit
  debit

  @@map("ledger_entry_type")
}

enum LedgerCategory {
  subscription
  token_spend
  api_spend
  refund
  chargeback
  payout
  misc

  @@map("ledger_category")
}

enum KbDocumentStatus {
  draft
  published
  archived

  @@map("kb_document_status")
}

enum audit_level {
  info
  warn
  error
  security
}

enum integration_provider {
  google
  microsoft
  icloud
  facebook
  instagram
  tiktok
  youtube
  twilio
  stripe
  openai
  deepseek
  supabase
}

enum job_status {
  queued
  running
  succeeded
  failed
  canceled
}

enum TicketStatus {
  OPEN
  TRIAGED
  IN_PROGRESS
  CLOSED

  @@map("ticket_status")
}

enum TicketSeverity {
  LOW
  MEDIUM
  HIGH
  BLOCKER

  @@map("ticket_severity")
}

enum TicketCategory {
  BUG
  UX
  GUARDRAIL
  PERFORMANCE
  OTHER

  @@map("ticket_category")
}
